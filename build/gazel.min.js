function createUuid(t,e){for(e=t="";36>t++;e+=52&51*t?(15^t?8^Math.random()*(20^t?16:4):4).toString(16):"-");return e}function Dict(){this.items={}}function Trans(){Dict.call(this)}function Client(){this.chain=[],this.inMulti=!1,this.returned=[],this.trans=new Trans,this.transMap=new Dict,this.events=new Dict}function openDatabase(t,e,n){if(db&&db.version==gazel.version&&db.name===gazel.dbName)return t(db),void 0;if(loadingDb)return setTimeout(function(){openDatabase(t,e)},100),void 0;loadingDb=!0;var r=window.indexedDB.open(gazel.dbName,gazel.version);r.onupgradeneeded=function(t){var e=t.target.result;if(e.objectStoreNames.contains(gazel.osName)||e.createObjectStore(gazel.osName),!e.objectStoreNames.contains(gazel.setsOsName)){var r=e.createObjectStore(gazel.setsOsName);r.createIndex("key","key",{unique:!1})}n&&n(e)};var i;i=r.onsuccess=function(n){var o=n.target.result;if(o.setVersion&&Number(o.version)!==gazel.version){db&&db.close();var a=o.setVersion(gazel.version+"");return a.onsuccess=function(t){var e={};e.target={},e.target.result=t.target.result.db,r.onupgradeneeded(e),i(e)},a.onerror=e,a.onfailure=e,a.onblocked=e,void 0}db=o,loadingDb=!1,t(db)},r.onerror=function(r){return r&&12===r.target.errorCode?(gazel.version++,openDatabase(t,e,n),void 0):(e(r),void 0)},r.onblocked=e}function ensureObjectStore(t,e,n){openDatabase(function(r){return r.objectStoreNames.contains(t)?(e(),void 0):(r.close(),gazel.version++,ensureObjectStore(t,e,n),void 0)},n,function(e){e.objectStoreNames.contains(t)||e.createObjectStore(t)})}function getKey(t,e,n,r,i,o,a,s){openDatabase(function(c){var l=e.pull(c,t,n,s||IDBTransaction.READ_ONLY),u=l.objectStore(t).get(r);u.onerror=o,u.onsuccess=function(t){i.call(a,t.target.result)}},o)}function setValue(t,e,n,r,i,o,a,s){openDatabase(function(c){var l=e.pull(c,t,n,IDBTransaction.READ_WRITE),u=l.objectStore(t).put(i,r);u.onerror=a,u.onsuccess=function(t){var e=t.target.result===r?"OK":"ERR";o.call(s,e)}},a)}function deleteKey(t,e,n,r,i,o,a){openDatabase(function(s){for(var c=e.pull(s,t,n,IDBTransaction.READ_WRITE),l=c.objectStore(t),u=r.length,d=r.length;r.length>0;)(function(){var t=r.shift(),e=l.delete(t);e.onerror=o,e.onsuccess=function(){u--,0===u&&i.call(a,d)}})()})}function transverseKeys(t,e,n,r,i,o,a,s,c){openDatabase(function(a){var l=e.pull(a,t,n,c||IDBTransaction.READ_ONLY),u=l.objectStore(t).index(r),d=window.IDBKeyRange.only(i);u.openCursor(d).onsuccess=function(t){var e=t.target.result;e?o.call(s,e.value)&&e.continue():o.call(s)}})}var gazel=gazel||{},exists=function(t){return t!==void 0&&null!=t},isInt=function(t){return!isNaN(t)&&0===t%1};window.indexedDB=window.indexedDB||window.mozIndexedDB||window.msIndexedDB||window.webkitIndexedDB||window.oIndexedDB,window.IDBTransaction=window.IDBTransaction||window.webkitIDBTransaction,window.IDBTransaction.READ_ONLY=window.IDBTransaction.READ_ONLY||"readonly",window.IDBTransaction.READ_WRITE=window.IDBTransaction.READ_WRITE||"readwrite",window.IDBKeyRange=window.IDBKeyRange||window.webkitIDBKeyRange;var slice=Array.prototype.slice;Dict.prototype={prop:function(t){return":"+t},get:function(t,e){var n=this.prop(t),r=this.items;return r.hasOwnProperty(n)?r[n]:e},set:function(t,e){var n=this.prop(t);return this.items[n]=e,e},count:function(){return Object.keys(this.items).length},has:function(t){var e=this.prop(t);return this.items.hasOwnProperty(e)},del:function(t){var e=this.prop(t),n=this.items;n.hasOwnProperty(e)&&delete n[e]},keys:function(){return Object.keys(this.items).map(function(t){return t.substring(1)})}},Trans.prototype=Object.create(Dict.prototype),Trans.prototype.constructor=Trans,Trans.prototype.add=function(){var t=createUuid();return this.set(t,void 0),t},Trans.prototype.abortAll=function(){var t=this,e=t.keys();e.forEach(function(e){var n=t.get(e);n&&n.abort(),t.del(e)})},Trans.prototype.pull=function(t,e,n,r){var i=this.get(n);return i||(i=t.transaction([e],r),i.onerror=onerror,this.set(n,i)),i},Client.prototype={register:function(t,e,n,r){var i,o=this,a=this.inMulti;return r&&!this.inMulti&&this.multi(),this.inMulti&&(i=this.transMap.get(t),i||(i=this.trans.add(),this.transMap.set(t,i)),this.chain.push({uuid:i,action:e}),a)?void 0:(i||(i=o.trans.add()),r?(this.exec(function(t){(n||function(){}).apply(null,t[0])}),void 0):(e(i,function(){var t=slice.call(arguments);o.trans.del(i),(n||function(){}).apply(null,t)}),void 0))},flush:function(){var t=slice.call(arguments)||[];if(this.returned.push(t),0===this.chain.length)return this.complete(),void 0;var e=this.chain.shift();e.action.call(this,e.uuid,this.flush)},multi:function(){return this.chain=[],this.inMulti=!0,this},exec:function(t){this.inMulti=!1,this.complete=function(){var e=this,n=this.returned;this.complete=null,this.chain=null,this.returned=[],this.transMap.keys().forEach(function(t){var n=e.transMap.get(t);e.trans.del(n)}),this.transMap=new Dict,t(n)};var e=this.chain.shift();e.action.call(this,e.uuid,this.flush)},on:function(t,e){var n=this.events.get(t);n||(n=[],this.events.set(t,n)),n.push(e)},off:function(t,e){if(!e)return this.events.del(t),void 0;var n=this.events.get(t);n.splice(n.indexOf(e),1)}},Client.prototype.discard=function(t){try{this.trans.abortAll(),(t||function(){})("OK")}catch(e){this.handleError(e)}},Client.prototype.handleError=function(){var t=slice.call(arguments);(this.events.get("error")||[]).forEach(function(e){e.apply(null,t)})},Client.prototype.get=function(t,e){var n=this;return this.register("read",function(e,r){getKey(gazel.osName,n.trans,e,t,r,n.handleError.bind(n),n)},e),this},Client.prototype.set=function(t,e,n){var r=this;return this.register("write",function(n,i){setValue(gazel.osName,r.trans,n,t,e,i,r.handleError.bind(r),r)},n),this},Client.prototype.incrby=function(t,e,n){var r=this;return this.register("write",function(n,i){var o=r.handleError.bind(r),a=gazel.osName,s=r.trans;getKey(a,s,n,t,function(c){if(c=c||0,!isInt(c))return o("ERROR: Cannot increment a non-integer value."),void 0;var l=c+e;setValue(a,s,n,t,l,function(t){i.call(r,"OK"===t?l:"ERR")},o,r)},o,r,IDBTransaction.READ_WRITE)},n),this},Client.prototype.incr=function(t,e){return this.incrby(t,1,e)},Client.prototype.decrby=function(t,e,n){return this.incrby(t,-e,n)},Client.prototype.decr=function(t,e){return this.incrby(t,-1,e)},Client.prototype.del=function(){var t=this,e=slice.call(arguments),n=e[e.length>0?e.length-1:0];"function"!=typeof n?n=void 0:e.splice(e.length-1);var r=e;return this.register("write",function(e,n){deleteKey(gazel.osName,t.trans,e,r,n,t.handleError.bind(t),t)},n),this},gazel.print=function(){var t=slice.call(arguments);0!==t.length&&(Array.isArray(t[0])?t[0]:[t[0]]).forEach(function(t){console.log(t)})},gazel.dbName="gazeldb",gazel.osName="gazelos",gazel.setsOsName="gazelos.sets",gazel.version=2;var VERSION_KEY="_gazel.version",version=localStorage[VERSION_KEY]&&0|localStorage[VERSION_KEY]||1;Object.defineProperty(gazel,"version",{get:function(){return version},set:function(t){version=t,localStorage[VERSION_KEY]=t}}),gazel.compatible=exists(window.indexedDB)&&exists(window.IDBTransaction),gazel.createClient=function(){return new Client},this.gazel=gazel;var db,loadingDb=!1;