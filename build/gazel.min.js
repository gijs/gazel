(function(undefined){function createUuid(a,b){for(b=a="";36>a++;b+=52&51*a?(15^a?8^Math.random()*(20^a?16:4):4).toString(16):"-");return b}function Dict(){this.items={}}function Trans(){Dict.call(this)}function Client(){this.chain=[],this.inMulti=!1,this.returned=[],this.trans=new Trans,this.transMap=new Dict,this.events=new Dict}function openDatabase(onsuccess,onerror,onupgrade){if(db&&db.version==gazel.version&&db.name===gazel.dbName)return onsuccess(db),undefined;if(loadingDb)return setTimeout(function(){openDatabase(onsuccess,onerror)},100),undefined;loadingDb=!0;var req=window.indexedDB.open(gazel.dbName,gazel.version);req.onupgradeneeded=function(e){var uDb=e.target.result;uDb.objectStoreNames.contains(gazel.osName)||uDb.createObjectStore(gazel.osName),onupgrade&&onupgrade(uDb)};var reqSuccess;reqSuccess=req.onsuccess=function(e){var sDb=e.target.result;if(sDb.setVersion&&Number(sDb.version)!==gazel.version){db&&db.close();var dbReq=sDb.setVersion(gazel.version+"");return dbReq.onsuccess=function(e2){var e3={};e3.target={},e3.target.result=e2.target.result.db,req.onupgradeneeded(e3),reqSuccess(e3)},dbReq.onerror=onerror,dbReq.onfailure=onerror,dbReq.onblocked=onerror,undefined}db=sDb,loadingDb=!1,onsuccess(db)},req.onerror=function(err){return err&&12===err.target.errorCode?(gazel.version++,openDatabase(onsuccess,onerror,onupgrade),undefined):(onerror(err),undefined)},req.onblocked=onerror}function ensureObjectStore(osName,callback,errback){openDatabase(function(db){return db.objectStoreNames.contains(osName)?(callback(),undefined):(db.close(),gazel.version++,ensureObjectStore(osName,callback,errback),undefined)},errback,function(db){db.objectStoreNames.contains(osName)||db.createObjectStore(osName)})}var gazel=gazel||{},exists=function(obj){return obj!==undefined&&null!=obj},isInt=function(n){return!isNaN(n)&&0==n%1};window.indexedDB=window.indexedDB||window.mozIndexedDB||window.msIndexedDB||window.webkitIndexedDB||window.oIndexedDB,window.IDBTransaction=window.IDBTransaction||window.webkitIDBTransaction,window.IDBTransaction.READ_ONLY=window.IDBTransaction.READ_ONLY||"readonly",window.IDBTransaction.READ_WRITE=window.IDBTransaction.READ_WRITE||"readwrite";var slice=Array.prototype.slice;Dict.prototype={prop:function(key){return":"+key},get:function(key,def){var p=this.prop(key),k=this.items;return k.hasOwnProperty(p)?k[p]:def},set:function(key,value){var p=this.prop(key);return this.items[p]=value,value},count:function(){return Object.keys(this.items).length},has:function(key){var p=this.prop(key);return this.items.hasOwnProperty(p)},del:function(key){var p=this.prop(key),k=this.items;k.hasOwnProperty(p)&&delete k[p]},keys:function(){return Object.keys(this.items).map(function(key){return key.substring(1)})}},Trans.prototype=Object.create(Dict.prototype),Trans.prototype.constructor=Trans,Trans.prototype.add=function(){var uuid=createUuid();return this.set(uuid,undefined),uuid},Trans.prototype.abortAll=function(){var self=this,keys=self.keys();keys.forEach(function(key){var tx=self.get(key);tx&&tx.abort(),self.del(key)})},Trans.prototype.pull=function(db,os,uuid,perm){var tx=this.get(uuid);return tx||(tx=db.transaction([os],perm),tx.onerror=onerror,this.set(uuid,tx)),tx},Client.prototype={register:function(type,action,callback){var uuid,self=this;return this.needsOsVerification?(ensureObjectStore(this.osName,function(){self.needsOsVerification=!1,self.register(type,action,callback)},this.handleError.bind(this)),undefined):this.inMulti?(uuid=this.transMap.get(type),uuid||(uuid=this.trans.add(),this.transMap.set(type,uuid)),this.chain.push({uuid:uuid,action:action}),undefined):(uuid=self.trans.add(),action(uuid,function(){var args=slice.call(arguments);self.trans.del(uuid),(callback||function(){}).apply(null,args)}),undefined)},flush:function(){var args=slice.call(arguments)||[];if(this.returned.push(args),0===this.chain.length)return this.complete(),undefined;var item=this.chain.shift();item.action.call(this,item.uuid,this.flush)},multi:function(){return this.chain=[],this.inMulti=!0,this},exec:function(callback){this.inMulti=!1,this.complete=function(){var self=this,returned=this.returned;this.complete=null,this.chain=null,this.returned=[],this.transMap.keys().forEach(function(key){var uuid=self.transMap.get(key);self.trans.del(uuid)}),this.transMap=new Dict,callback(returned)};var item=this.chain.shift();item.action.call(this,item.uuid,this.flush)},on:function(eventType,action){var event=this.events.get(eventType);event||(event=[],this.events.set(eventType,event)),event.push(action)},off:function(eventType,action){if(!action)return this.events.del(eventType),undefined;var event=this.events.get(eventType);event.splice(event.indexOf(action),1)}},Client.prototype.discard=function(callback){try{this.trans.abortAll(),(callback||function(){})("OK")}catch(err){this.handleError(err)}},Client.prototype.handleError=function(){var args=slice.call(arguments);(this.events.get("error")||[]).forEach(function(action){action.apply(null,args)})},Client.prototype.get=function(key,callback){var self=this;return this.register("read",function(uuid,cb){openDatabase(function(db){var tx=self.trans.pull(db,self.osName,uuid,IDBTransaction.READ_ONLY),req=tx.objectStore(self.osName).get(key);req.onerror=self.handleError.bind(self),req.onsuccess=function(e){cb.call(self,e.target.result)}},self.handleError.bind(self))},callback),this},Client.prototype.set=function(key,value,callback){var self=this;return this.register("write",function(uuid,cb){openDatabase(function(db){var tx=self.trans.pull(db,self.osName,uuid,IDBTransaction.READ_WRITE),req=tx.objectStore(self.osName).put(value,key);req.onerror=self.handleError.bind(self),req.onsuccess=function(e){var res=e.target.result===key?"OK":"ERR";cb.call(self,res)}},self.handleError.bind(self))},callback),this},Client.prototype.incrby=function(key,increment,callback){var self=this;return this.register("write",function(uuid,cb){openDatabase(function(db){var tx=self.trans.pull(db,self.osName,uuid,IDBTransaction.READ_WRITE),os=tx.objectStore(self.osName);(function curl(val){if(!exists(val)){var req=os.get(key);return req.onerror=self.handleError.bind(self),req.onsuccess=function(e){curl(e.target.result===undefined?0:e.target.result)},undefined}if(!isInt(val))return self.handleError("ERROR: Cannot increment a non-integer value."),undefined;var value=val+increment,req=os.put(value,key);req.onerror=self.handleError.bind(self),req.onsuccess=function(e){var res=e.target.result===key?value:"ERR";cb.call(self,res)}})()},self.handleError.bind(self))},callback),this},Client.prototype.incr=function(key,callback){return this.incrby(key,1,callback)},Client.prototype.decrby=function(key,increment,callback){return this.incrby(key,-increment,callback)},Client.prototype.decr=function(key,callback){return this.incrby(key,-1,callback)},Client.prototype.del=function(){var self=this,args=slice.call(arguments),callback=args[args.length>0?args.length-1:0];"function"!=typeof callback?callback=undefined:args.splice(args.length-1);var keys=args,deleted=keys.length;return this.register("write",function(uuid,cb){openDatabase(function(db){for(var tx=self.trans.pull(db,self.osName,uuid,IDBTransaction.READ_WRITE),os=tx.objectStore(self.osName),left=keys.length;keys.length>0;)(function(){var key=keys.shift(),req=os.delete(key);req.onerror=self.handleError.bind(self),req.onsuccess=function(){left--,0===left&&cb.call(self,deleted)}})()})},callback),this},gazel.print=function(){var args=slice.call(arguments);0!==args.length&&(Array.isArray(args[0])?args[0]:[args[0]]).forEach(function(item){console.log(item)})},gazel.dbName="gazeldb",gazel.osName="gazelos";var VERSION_KEY="_gazel.version",version=localStorage[VERSION_KEY]&&parseInt(localStorage[VERSION_KEY])||1;Object.defineProperty(gazel,"version",{get:function(){return version},set:function(v){version=v,localStorage[VERSION_KEY]=v}}),gazel.compatible=exists(window.indexedDB)&&exists(window.IDBTransaction),gazel.createClient=function(osName){var client=new Client;return client.osName=osName||gazel.osName,osName&&(client.needsOsVerification=!0),client},this.gazel=gazel;var db,loadingDb=!1}).call(this);